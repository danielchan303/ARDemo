<!-- import aframe and then ar.js with image tracking / location based features -->
<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
<script src="gesture-detector.js"></script>
<script src="gesture-handler.js"></script>
<script>
  let numOfReadyMarker = 0;
  window.addEventListener("arjs-nft-loaded", (e) => {
    console.log("nft loading finished");
    numOfReadyMarker++;
    if (numOfReadyMarker == 10) {
      document.querySelector(".my-loader").style.display = "none";
    }
  });
</script>
<link rel="stylesheet" href="index.css" />
<link rel="stylesheet" href="spinner.css" />

<body style="margin: 0px; overflow: hidden">
  <!-- minimal loader shown until image descriptors are loaded. Loading may take a while according to the device computational power -->
  <div class="my-loader">
    <div class="lds-ellipsis">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>

  <!-- a-frame scene -->
  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true;"
    embedded
    gesture-detector
    arjs="trackingMethod: best; sourceType: webcam;debugUIEnabled: false;"
  >
    <a-assets>
      <a-asset-item
        id="butterfly-model"
        src="models/butterfly/scene.gltf"
      ></a-asset-item>
      <a-asset-item id="crab-model" src="models/crab/scene.gltf"></a-asset-item>
      <a-asset-item
        id="dolphin-model"
        src="models/dolphin/scene.gltf"
      ></a-asset-item>
    </a-assets>
    <!-- a-nft is the anchor that defines an Image Tracking entity -->
    <!-- on 'url' use the path to the Image Descriptors created before. -->
    <!-- the path should end with the name without the extension e.g. if file is 'pinball.fset' the path should end with 'pinball' -->
    <a-nft
      id="bridge"
      type="nft"
      url="markers/bridge"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="buddha"
      type="nft"
      url="markers/buddha"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="butterfly"
      type="nft"
      url="markers/butterfly"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    >
      <!-- as a child of the a-nft entity, you can define the content to show. here's a GLTF model entity -->
      <a-entity
        animation-mixer
        gltf-model="#butterfly-model"
        scale="3 3 3"
        position="0 0 -170"
        rotation="0 0 0"
        class="clickable"
        gesture-handler="minScale: 1; maxScale: 10"
      >
      </a-entity>
    </a-nft>
    <a-nft
      id="canon"
      type="nft"
      url="markers/canon"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="crab"
      type="nft"
      url="markers/crab"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    >
      <a-entity
        animation-mixer
        gltf-model="#crab-model"
        scale="13 13 13"
        position="0 0 -170"
        rotation="0 0 0"
        class="clickable"
        gesture-handler="minScale: 1; maxScale: 10"
      >
      </a-entity>
    </a-nft>
    <a-nft
      id="dcm"
      type="nft"
      url="markers/dcm"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="dolphin"
      type="nft"
      url="markers/dolphin"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    >
      <a-entity
        animation-mixer
        gltf-model="#dolphin-model"
        scale="1 1 1"
        position="0 0 -170"
        rotation="0 0 0"
        class="clickable"
        gesture-handler="minScale: 1; maxScale: 10"
      >
      </a-entity>
    </a-nft>
    <a-nft
      id="park"
      type="nft"
      url="markers/park"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="shore"
      type="nft"
      url="markers/shore"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <a-nft
      id="temple"
      type="nft"
      url="markers/temple"
      raycaster="objects: .clickable"
      cursor="fuse: false; rayOrigin: mouse;"
      emitevents="true"
      smooth="true"
      smoothCount="10"
      smoothTolerance=".01"
      smoothThreshold="5"
    ></a-nft>
    <!-- static camera that moves according to the device movements -->
    <a-entity camera></a-entity>
  </a-scene>
  <div id="popup">
    <div id="message-box">
      <p>You have found ...</p>
      <button id="cancel">Cancel</button>
      <a href="./trial" target="_blank">View the model</a>
    </div>
  </div>

  <script>
    // Cancel button handler
    document.querySelector("#cancel").addEventListener("click", () => {
      document.querySelector("#popup").style.display = "none";
    });

    let lastFound = "";
    function findTargetName(name) {
      if (lastFound !== name) {
        document.querySelector(
          "#message-box p"
        ).innerHTML = `You have found ${name}`;
        document.querySelector("#popup").style.display = "flex";

        lastFound = name;
      }
    }

    var handleRotation = (event) => {
      if (isMarkerVisible) {
        el.object3D.rotation.y +=
          event.detail.positionChange.y * rotationFactor;

        el.object3D.rotation.x +=
          event.detail.positionChange.x * rotationFactor;
      }
    };

    var handleScale = (event) => {
      if (isMarkerVisible) {
        this.scaleFactor *=
          1 + event.detail.spreadChange / event.detail.startSpread;

        this.scaleFactor = Math.min(
          Math.max(this.scaleFactor, this.data.minScale),
          this.data.maxScale
        );

        el.object3D.scale.x = scaleFactor * initialScale.x;
        el.object3D.scale.y = scaleFactor * initialScale.y;
        el.object3D.scale.z = scaleFactor * initialScale.z;
      }
    };

    let bridge = document.querySelector("#bridge");
    bridge.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("bridge");
    });
    let buddha = document.querySelector("#buddha");
    buddha.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("buddha");
    });
    let butterfly = document.querySelector("#butterfly");
    butterfly.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("butterfly");
    });
    let canon = document.querySelector("#canon");
    canon.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("canon");
    });
    let crab = document.querySelector("#crab");
    crab.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("crab");
    });
    let dcm = document.querySelector("#dcm");
    dcm.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("dcm");
    });
    let dolphin = document.querySelector("#dolphin");
    dolphin.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("dolphin");
    });
    let park = document.querySelector("#park");
    park.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("park");
    });
    let shore = document.querySelector("#shore");
    shore.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("shore");
    });
    let temple = document.querySelector("#temple");
    temple.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      findTargetName("temple");
    });

    let sceneEl = document.querySelector("a-scene");
    sceneEl.addEventListener("markerFound", (e) => {
      isMarkerVisible = true;
      //   alert("marker found");
    });

    sceneEl.addEventListener("markerLost", (e) => {
      isMarkerVisible = false;
      // alert("marker lost");
    });

    sceneEl.addEventListener("onefingermove", handleRotation);
    sceneEl.addEventListener("twofingermove", handleScale);
  </script>
</body>
